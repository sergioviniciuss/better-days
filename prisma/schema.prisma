// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String   @id
  email                  String   @unique
  timezone               String   @default("UTC")
  preferredLanguage      String   @default("en")
  hasCompletedOnboarding Boolean  @default(false)
  createdAt              DateTime @default(now())

  dailyLogs        DailyLog[]
  ownedChallenges  Challenge[] @relation("ChallengeOwner")
  challengeMembers ChallengeMember[]
}

model DailyLog {
  id           String    @id @default(uuid())
  userId       String
  challengeId  String
  date         String // YYYY-MM-DD in user timezone
  consumedSugar Boolean
  confirmedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenge    Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([userId, challengeId, date])
  @@index([userId, challengeId, date])
}

model Challenge {
  id            String    @id @default(uuid())
  ownerUserId   String
  name          String
  objectiveType String    @default("NO_SUGAR_STREAK") // enum would be better but using string for simplicity
  challengeType String    @default("PERSONAL") // "PERSONAL" | "GROUP"
  rules         String[]  // Array of rule strings
  startDate     String    // YYYY-MM-DD
  dueDate       String?   // Optional: YYYY-MM-DD
  shortId       String    @unique // 8-char unique ID like "A3F2B1C9"
  status        String    @default("ACTIVE") // "ACTIVE" | "ARCHIVED"
  createdAt     DateTime  @default(now())

  owner         User      @relation("ChallengeOwner", fields: [ownerUserId], references: [id], onDelete: Cascade)
  members       ChallengeMember[]
  invites       Invite[]
  dailyLogs     DailyLog[]
}

model ChallengeMember {
  id          String    @id @default(uuid())
  challengeId String
  userId      String
  role        String    @default("MEMBER") // "OWNER" | "MEMBER"
  status      String    @default("ACTIVE") // "ACTIVE" | "LEFT"
  joinedAt    DateTime  @default(now())
  leftAt      DateTime?

  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([challengeId, userId])
  @@index([challengeId])
  @@index([userId])
}

model Invite {
  id         String    @id @default(uuid())
  challengeId String
  code       String    @unique
  createdAt  DateTime  @default(now())
  expiresAt  DateTime?

  challenge  Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([challengeId])
}
