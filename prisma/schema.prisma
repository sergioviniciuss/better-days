// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String    @id
  email                  String    @unique
  timezone               String    @default("UTC")
  preferredLanguage      String    @default("en")
  hasCompletedOnboarding Boolean   @default(false)
  totalAchievements      Int       @default(0)
  lastAchievementAt      DateTime?
  createdAt              DateTime  @default(now())

  dailyLogs        DailyLog[]
  ownedChallenges  Challenge[]         @relation("ChallengeOwner")
  challengeMembers ChallengeMember[]
  achievements     UserAchievement[]
}

model DailyLog {
  id           String    @id @default(uuid())
  userId       String
  challengeId  String
  date         String // YYYY-MM-DD in user timezone
  consumedSugar Boolean
  confirmedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenge    Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([userId, challengeId, date])
  @@index([userId, challengeId, date])
}

model Challenge {
  id            String    @id @default(uuid())
  ownerUserId   String
  name          String
  objectiveType String    @default("NO_SUGAR_STREAK") // enum would be better but using string for simplicity
  challengeType String    @default("PERSONAL") // "PERSONAL" | "GROUP"
  rules         String[]  // Array of rule strings
  startDate     String    // YYYY-MM-DD
  dueDate       String?   // Optional: YYYY-MM-DD
  shortId       String    @unique // 8-char unique ID like "A3F2B1C9"
  status        String    @default("ACTIVE") // "ACTIVE" | "ARCHIVED"
  rulesUpdatedAt DateTime? // Timestamp when rules were last updated by admin
  createdAt     DateTime  @default(now())

  owner            User              @relation("ChallengeOwner", fields: [ownerUserId], references: [id], onDelete: Cascade)
  members          ChallengeMember[]
  invites          Invite[]
  dailyLogs        DailyLog[]
  userAchievements UserAchievement[]
}

model ChallengeMember {
  id                        String    @id @default(uuid())
  challengeId               String
  userId                    String
  role                      String    @default("MEMBER") // "OWNER" | "MEMBER"
  status                    String    @default("ACTIVE") // "ACTIVE" | "LEFT"
  totalAchievements         Int       @default(0)
  joinedAt                  DateTime  @default(now())
  leftAt                    DateTime?
  lastAcknowledgedRulesAt   DateTime? // Timestamp when member last acknowledged rule changes

  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([challengeId, userId])
  @@index([challengeId])
  @@index([userId])
}

model Invite {
  id         String    @id @default(uuid())
  challengeId String
  code       String    @unique
  createdAt  DateTime  @default(now())
  expiresAt  DateTime?

  challenge  Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([challengeId])
}

model Achievement {
  id          String   @id
  code        String   @unique
  category    String   // "STREAK" | "CONSISTENCY" | "SOCIAL" | "CHALLENGE"
  tier        String   // "BRONZE" | "SILVER" | "GOLD" | "PLATINUM" | "LEGENDARY"
  name        String
  description String
  iconEmoji   String
  requirement Json     // { type: string, value: number, challengeType?: string }
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  userAchievements UserAchievement[]

  @@index([code])
  @@index([category])
}

model UserAchievement {
  id            String    @id @default(uuid())
  userId        String
  achievementId String
  challengeId   String?
  earnedAt      DateTime  @default(now())
  viewedAt      DateTime?
  progress      Int?

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  challenge   Challenge?  @relation(fields: [challengeId], references: [id], onDelete: SetNull)

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
  @@index([challengeId])
  @@index([earnedAt])
}
